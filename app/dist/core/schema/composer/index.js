"use strict";function _typeof(a){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(a){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}var InvalidAttributeError=require("./error/invalid-attribute"),InvalidCollectionError=require("./error/invalid-collection"),InvalidSchemaError=require("./error/invalid-schema"),SchemaNotFoundError=require("./error/schema-not-found"),FilterIsNotHoneringContractError=require("./error/filter-is-not-honering-contract"),ValidatorIsNotHoneringContractError=require("./error/validator-is-not-honering-contract"),ValidatorNotFoundError=require("./error/validator-not-found"),SchemaComposer=function(){function a(b,c,d){_classCallCheck(this,a),this.deepmerge=b,this.deepclone=c,this.deepfreeze=d,this.schemas={},this.filters={},this.validators={}}return _createClass(a,[{key:"compose",value:function compose(a,b){var c;if(!1==a in this.schemas){var f="Schema: \"".concat(a,"\" not found");throw new SchemaNotFoundError(f)}Array.isArray(b)&&(b=(c=this.deepmerge).merge.apply(c,[{}].concat(_toConsumableArray(b))));var d=this.buildSchema(this.schemas[a]),e={};for(var g in d)e[g]=this.attribute(a,d,g,b[g]);return Object.isFrozen(d)&&this.deepfreeze.freeze(e),e}},{key:"trait",value:function trait(a,b,c){if(!1==a in this.schemas){var f="Schema: \"".concat(a,"\" not found");throw new SchemaNotFoundError(f)}var d=this.schemas[a],e=this.attribute(a,d,b,c);return e}},{key:"attribute",value:function attribute(a,b,c,d){var e=b[c];if("default"in e&&void 0===d&&(d=e["default"]),!0===e.optional&&void 0===d)return d;if(!0===e.nullable&&null===d)return d;if(e.type in this.filters){var l=this.filters[e.type];d=l.filter(e,d)}if(!1==e.type in this.validators){var m="In schema: \"".concat(a,"\", validator: \"").concat(e.type,"\" not found");throw new ValidatorNotFoundError(m)}try{var n=this.validators[e.type];if(e.collection){if(!Array.isArray(d)){var o="In schema: \"".concat(a,"\", invalid type: \"").concat(_typeof(d),"\", array expected");throw new InvalidCollectionError(o)}var f=!0,g=!1,h=void 0;try{for(var i,j,k=d[Symbol.iterator]();!(f=(i=k.next()).done);f=!0)j=i.value,n.valid(e,j)}catch(a){g=!0,h=a}finally{try{f||null==k["return"]||k["return"]()}finally{if(g)throw h}}}else n.valid(e,d)}catch(b){var p="Invalid attribute: \"".concat(c,"\", schema: \"").concat(a,"\", error: ").concat(b.message);throw new InvalidAttributeError(p)}return d}},{key:"buildSchema",value:function buildSchema(a){if("@meta"in a){if("extends"in a["@meta"]||"extend"in a["@meta"]){var b=a["@meta"]["extends"]||a["@meta"].extend,c=!0,d=!1,e=void 0;try{for(var f,g=(Array.isArray(b)?b:[b])[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=f.value,i=this.buildSchema(this.schemas[h]);this.deepmerge.merge(a,i)}}catch(a){d=!0,e=a}finally{try{c||null==g["return"]||g["return"]()}finally{if(d)throw e}}}a["@meta"].immutable||void 0===a["@meta"].immutable?(delete a["@meta"],Object.freeze(a)):delete a["@meta"]}return a}},{key:"addSchema",value:function addSchema(a,b){if("object"!==_typeof(b)){var c="Schema \"".concat(a,"\" must be an object");throw new InvalidSchemaError(c)}this.schemas[a]=this.deepclone.clone(b)}},{key:"addFilter",value:function addFilter(a,b){if("function"!=typeof b.filter){var c="Filter \"".concat(a,"\" not honering contract");throw new FilterIsNotHoneringContractError(c)}this.filters[a]=b}},{key:"addValidator",value:function addValidator(a,b){if("function"!=typeof b.valid){var c="Validator \"".concat(a,"\" not honering contract");throw new ValidatorIsNotHoneringContractError(c)}this.validators[a]=b}}]),a}();module.exports=SchemaComposer;